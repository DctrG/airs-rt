<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gemini Agent</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    .container { max-width: 820px; margin: auto; }
    textarea { width: 100%; height: 140px; padding: 12px; font-size: 16px; }
    button { padding: 10px 14px; font-size: 16px; cursor: pointer; }
    select { padding: 10px 14px; font-size: 16px; }
    pre { background: #f6f8fa; padding: 12px; white-space: pre-wrap; word-wrap: break-word; }
    .row { display: flex; gap: 8px; align-items: center; }
    .row > * { flex: 1; }
    .row > button { flex: 0; }
    .row > select { flex: 0; min-width: 180px; }
    .model-selector { margin-bottom: 12px; }
    .model-selector label { margin-right: 8px; font-weight: 500; }
  </style>
  <script>
    let availableModels = [];
    let selectedModel = null;

    // Fetch available models on page load
    async function loadModels() {
      try {
        const res = await fetch('/api/models', {
          credentials: 'include'
        });
        if (res.ok) {
          const data = await res.json();
          availableModels = data.models || [];
          populateModelDropdown();
        }
      } catch (e) {
        console.error('Failed to load models:', e);
        // Use default models as fallback
        availableModels = ['gemini-2.0-flash', 'gemini-1.5-pro', 'gemini-1.5-flash'];
        populateModelDropdown();
      }
    }

    function populateModelDropdown() {
      const select = document.getElementById('modelSelect');
      select.innerHTML = '';
      availableModels.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        select.appendChild(option);
      });
      // Set first model as default
      if (availableModels.length > 0) {
        selectedModel = availableModels[0];
      }
    }

    // Get auth token using gcloud auth (for domain-restricted access)
    async function getAuthToken() {
      return null; // Browser will use cookies/session if user is logged in
    }

    async function sendPrompt() {
      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) return;
      const btn = document.getElementById('sendBtn');
      btn.disabled = true; btn.textContent = 'Thinking...';
      try {
        const headers = { 'Content-Type': 'application/json' };
        
        const token = await getAuthToken();
        if (token) {
          headers['Authorization'] = `Bearer ${token}`;
        }

        const selectedModel = document.getElementById('modelSelect').value;
        const body = { prompt };
        if (selectedModel) {
          body.model = selectedModel;
        }

        const res = await fetch('/api/chat', { 
          method: 'POST', 
          headers: headers,
          credentials: 'include',
          body: JSON.stringify(body) 
        });
        
        if (!res.ok) {
          if (res.status === 403) {
            throw new Error('Access denied. Please ensure you are logged into Google with a @paloaltonetworks.com account.');
          }
          throw new Error(`HTTP ${res.status}: ${res.statusText}`);
        }
        
        const data = await res.json();
        if (data.error) {
          document.getElementById('response').textContent = 'Error: ' + data.error;
        } else {
          document.getElementById('response').textContent = data.text || '';
        }
        document.getElementById('tools').textContent = JSON.stringify(data.tools || [], null, 2);
      } catch (e) {
        document.getElementById('response').textContent = 'Error: ' + e.message;
      } finally {
        btn.disabled = false; btn.textContent = 'Ask';
      }
    }

    // Load models when page loads
    window.addEventListener('DOMContentLoaded', loadModels);
  </script>
  </head>
  <body>
    <div class="container">
      <h1>Gemini Agent</h1>
      <p>Ask questions that might require tools like web search, URL fetching, or calculations.</p>
      <div class="model-selector">
        <label for="modelSelect">Model:</label>
        <select id="modelSelect">
          <option>Loading models...</option>
        </select>
      </div>
      <div class="row">
        <textarea id="prompt" placeholder="e.g., Find the latest Gemini API updates and summarize them."></textarea>
        <button id="sendBtn" onclick="sendPrompt()">Ask</button>
      </div>
      <h3>Response</h3>
      <pre id="response"></pre>
      <h3>Tool Trace</h3>
      <pre id="tools"></pre>
    </div>
  </body>
</html>
